<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Peripheral Shop</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app">
  <h1>üõí Peripheral Shop</h1>

  <div id="degraded" class="degraded hidden">
    ‚ö†Ô∏è –°–µ—Ä–≤—ñ—Å –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.
  </div>

  <div class="search-box">
    <input id="q" placeholder="–ü–æ—à—É–∫: –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞, –º–∏—à–∫–∞...">
    <button id="btn">–ü–æ—à—É–∫</button>
  </div>

  <div class="create-box">
    <input id="newName" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É">
    <button id="createBtn">–°—Ç–≤–æ—Ä–∏—Ç–∏ (POST)</button>
  </div>

  <div id="result" class="products"></div>
</div>

<script>
const API = "http://localhost:8081";

const products = [];
const qEl = document.getElementById("q");
const btn = document.getElementById("btn");
const result = document.getElementById("result");
const degradedEl = document.getElementById("degraded");
const createBtn = document.getElementById("createBtn");
const newName = document.getElementById("newName");

let consecutiveFails = 0;

const sleep = ms => new Promise(r => setTimeout(r, ms));

function backoff(base, attempt) {
  return base * 2 ** attempt + Math.random() * 100;
}

async function fetchWithResilience(url, opts = {}) {
  const retries = opts.retries ?? 2;
  const attempt = opts._a ?? 0;

  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), 3500);

  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    if ([500,502,503,504].includes(res.status) && retries > 0) {
      await sleep(backoff(300, attempt));
      return fetchWithResilience(url, { ...opts, retries: retries - 1, _a: attempt + 1 });
    }
    return res;
  } catch {
    if (retries > 0) {
      await sleep(backoff(300, attempt));
      return fetchWithResilience(url, { ...opts, retries: retries - 1, _a: attempt + 1 });
    }
    throw new Error("network");
  } finally {
    clearTimeout(t);
  }
}

function show(list) {
  if (!list.length) {
    result.innerHTML = `<p class="empty">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>`;
    return;
  }
  result.innerHTML = list.map(p => `
    <div class="card">
      <h3>${p.name}</h3>
      <p>${p.brand}</p>
      <span>${p.type}</span>
      <b>${p.price} –≥—Ä–Ω</b>
    </div>
  `).join("");
}

btn.onclick = () => {
  const q = qEl.value.toLowerCase();
  show(products.filter(p =>
    p.name.toLowerCase().includes(q) || p.type.includes(q)
  ));
};

async function createProduct() {
  const payload = {
    name: newName.value || "Untitled",
    type: "mouse",
    brand: "Demo",
    price: 100
  };

  try {
    const res = await fetchWithResilience(`${API}/products`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Idempotency-Key": crypto.randomUUID() },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw data;

    products.push(data);
    show(products);
    consecutiveFails = 0;
    degradedEl.classList.add("hidden");
  } catch {
    consecutiveFails++;
    if (consecutiveFails >= 3) {
      degradedEl.classList.remove("hidden");
      createBtn.disabled = true;
      setTimeout(() => {
        createBtn.disabled = false;
        degradedEl.classList.add("hidden");
        consecutiveFails = 0;
      }, 5000);
    }
  }
}
createBtn.onclick = createProduct;

async function load() {
  const res = await fetch(`${API}/products`);
  const data = await res.json();
  products.push(...data);
  show(products);
}
load();
</script>

</body>
</html>
